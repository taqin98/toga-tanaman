<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR ke AR Marker Generator</title>
  <style>
    :root {
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #101418;
      --muted: #5b6670;
      --line: #d9e0e7;
      --brand: #0f766e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px 11px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
    }
    input[type="color"] {
      width: 100%;
      height: 42px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 0;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #e7ecef;
      color: #14212c;
    }
    button.primary {
      background: var(--brand);
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .preview {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fcfdff;
    }
    .panel h3 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    .preview-box {
      background: #f4f7fa;
      border-radius: 8px;
      overflow: auto;
      text-align: center;
      min-height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .preview-box img, .preview-box canvas {
      max-width: 100%;
      height: auto;
    }
    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      min-height: 20px;
    }
    @media (max-width: 780px) {
      .grid, .preview { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>QR ke AR Marker (.patt)</h1>
      <p>Upload gambar QR, lalu generate file marker PNG dan pattern <code>.patt</code> kompatibel AR.js.</p>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <label for="fileInput">Gambar QR</label>
          <input id="fileInput" type="file" accept="image/*" />
        </div>
        <div>
          <label for="markerId">Nama file output (tanpa ekstensi)</label>
          <input id="markerId" type="text" value="marker" />
        </div>
        <div>
          <label for="patternRatio">Pattern Ratio (default AR.js 0.52)</label>
          <input id="patternRatio" type="number" min="0.1" max="0.9" step="0.01" value="0.52" />
        </div>
        <div>
          <label for="imageSize">Image size (px)</label>
          <input id="imageSize" type="number" min="200" max="2000" step="10" value="600" />
        </div>
        <div>
          <label for="borderColor">Border color</label>
          <input id="borderColor" type="color" value="#000000" />
        </div>
      </div>

      <div class="actions">
        <button id="btnGenerate" class="primary">Generate</button>
        <button id="btnDownloadMarker" disabled>Download Marker PNG</button>
        <button id="btnDownloadPatt" disabled>Download .patt</button>
        <button id="btnPdfOne" disabled>PDF 1/Page</button>
        <button id="btnPdfTwo" disabled>PDF 2/Page</button>
        <button id="btnPdfSix" disabled>PDF 6/Page</button>
      </div>
      <div class="status" id="statusText"></div>
    </section>

    <section class="card preview">
      <div class="panel">
        <h3>Preview Input</h3>
        <div class="preview-box" id="inputPreview"></div>
      </div>
      <div class="panel">
        <h3>Preview Marker Output</h3>
        <div class="preview-box" id="markerPreview"></div>
      </div>
    </section>
  </main>

  <script src="assets/vendor/pdfMake/pdfmake.min.js"></script>
  <script src="assets/vendor/pdfMake/vfs_fonts.js"></script>
  <script src="assets/vendor/arjs/threex-arpatternfile.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const markerIdInput = document.getElementById("markerId");
    const patternRatioInput = document.getElementById("patternRatio");
    const imageSizeInput = document.getElementById("imageSize");
    const borderColorInput = document.getElementById("borderColor");
    const btnGenerate = document.getElementById("btnGenerate");
    const btnDownloadMarker = document.getElementById("btnDownloadMarker");
    const btnDownloadPatt = document.getElementById("btnDownloadPatt");
    const btnPdfOne = document.getElementById("btnPdfOne");
    const btnPdfTwo = document.getElementById("btnPdfTwo");
    const btnPdfSix = document.getElementById("btnPdfSix");
    const inputPreview = document.getElementById("inputPreview");
    const markerPreview = document.getElementById("markerPreview");
    const statusText = document.getElementById("statusText");

    let innerImageURL = null;
    let fullMarkerURL = null;

    function setStatus(text) {
      statusText.textContent = text || "";
    }

    function renderInputPreview(file, srcUrl) {
      inputPreview.innerHTML = "";
      const img = new Image();
      img.alt = file.name;
      img.src = srcUrl;
      inputPreview.appendChild(img);
    }

    function renderMarkerPreview(srcUrl) {
      markerPreview.innerHTML = "";
      const img = new Image();
      img.alt = "Marker";
      img.src = srcUrl;
      markerPreview.appendChild(img);
    }

    function safeFileBase() {
      return (markerIdInput.value || "marker")
        .trim()
        .replace(/[^a-zA-Z0-9_-]/g, "_")
        .replace(/_+/g, "_");
    }

    function setDownloadState(enabled) {
      const disabled = !enabled;
      btnDownloadMarker.disabled = disabled;
      btnDownloadPatt.disabled = disabled;
      btnPdfOne.disabled = disabled;
      btnPdfTwo.disabled = disabled;
      btnPdfSix.disabled = disabled;
    }

    function normalizeBorderColor(inputColor) {
      const value = String(inputColor || "").trim();
      const test = new Option().style;
      test.color = value;
      const isHex = /^#[0-9a-fA-F]{6}$/.test(value);
      if (!value || (test.color !== value && !isHex)) return "#000000";
      return value;
    }

    function updateFullMarkerImage() {
      if (!innerImageURL) {
        setStatus("Pilih gambar QR terlebih dahulu.");
        return;
      }

      if (!window.THREEx || !THREEx.ArPatternFile) {
        setStatus("Library THREEx.ArPatternFile tidak ter-load.");
        return;
      }

      const patternRatio = Number(patternRatioInput.value);
      const imageSize = Number(imageSizeInput.value);
      if (!Number.isFinite(patternRatio) || patternRatio <= 0 || patternRatio >= 1) {
        setStatus("Pattern Ratio harus di antara 0 dan 1.");
        return;
      }
      if (!Number.isFinite(imageSize) || imageSize < 200) {
        setStatus("Image size minimal 200.");
        return;
      }

      const borderColor = normalizeBorderColor(borderColorInput.value);
      borderColorInput.value = borderColor.startsWith("#") ? borderColor : "#000000";

      THREEx.ArPatternFile.buildFullMarker(
        innerImageURL,
        patternRatio,
        Math.floor(imageSize),
        borderColor,
        function onComplete(markerUrl) {
          fullMarkerURL = markerUrl;
          renderMarkerPreview(markerUrl);
          setDownloadState(true);
          setStatus("Generate selesai. Silakan download marker PNG, .patt, atau PDF.");
        }
      );
    }

    function generatePdf(mode) {
      if (!fullMarkerURL || !window.pdfMake) return;

      let docDefinition;
      if (mode === 1) {
        docDefinition = {
          content: [{ image: fullMarkerURL, width: 600, alignment: "center" }]
        };
      } else if (mode === 2) {
        docDefinition = {
          content: [
            { image: fullMarkerURL, width: 300, alignment: "center" },
            { image: fullMarkerURL, width: 300, alignment: "center" }
          ]
        };
      } else {
        docDefinition = {
          content: [
            { columns: [{ image: fullMarkerURL, width: 250 }, { image: fullMarkerURL, width: 250 }] },
            { columns: [{ image: fullMarkerURL, width: 250 }, { image: fullMarkerURL, width: 250 }] },
            { columns: [{ image: fullMarkerURL, width: 250 }, { image: fullMarkerURL, width: 250 }] }
          ]
        };
      }
      pdfMake.createPdf(docDefinition).open();
    }

    fileInput.addEventListener("change", () => {
      innerImageURL = null;
      fullMarkerURL = null;
      setDownloadState(false);
      markerPreview.innerHTML = "";

      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        inputPreview.innerHTML = "";
        setStatus("");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        innerImageURL = String(reader.result || "");
        renderInputPreview(file, innerImageURL);
        setStatus("Gambar siap. Klik Generate.");
      };
      reader.readAsDataURL(file);
    });

    btnGenerate.addEventListener("click", () => {
      updateFullMarkerImage();
    });

    btnDownloadMarker.addEventListener("click", () => {
      if (!fullMarkerURL) return;
      const base = safeFileBase();
      const a = document.createElement("a");
      a.href = fullMarkerURL;
      a.download = `${base}-marker.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnDownloadPatt.addEventListener("click", () => {
      if (!innerImageURL) return;
      const base = safeFileBase();
      THREEx.ArPatternFile.encodeImageURL(innerImageURL, function onComplete(patternFileString) {
        THREEx.ArPatternFile.triggerDownload(patternFileString, `${base}.patt`);
      });
    });

    btnPdfOne.addEventListener("click", () => generatePdf(1));
    btnPdfTwo.addEventListener("click", () => generatePdf(2));
    btnPdfSix.addEventListener("click", () => generatePdf(6));

    patternRatioInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
    imageSizeInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
    borderColorInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
  </script>
</body>
</html>
