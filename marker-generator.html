<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR ke AR Marker Generator</title>
  <style>
    :root {
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #101418;
      --muted: #5b6670;
      --line: #d9e0e7;
      --brand: #0f766e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="number"],
    input[type="file"] {
      width: 100%;
      padding: 10px 11px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
    }
    input[type="color"] {
      width: 100%;
      height: 42px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 0;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #e7ecef;
      color: #14212c;
    }
    button.primary {
      background: var(--brand);
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .preview {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .results {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top: 12px;
    }
    .result-card {
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
    }
    .result-card h4 {
      font-size: 0.95rem;
      margin: 0 0 8px;
      word-break: break-all;
    }
    .result-thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      object-fit: contain;
      background: #f4f6fb;
    }
    .result-actions {
      display: grid;
      gap: 8px;
      margin-top: 12px;
    }
    .result-actions button {
      width: 100%;
    }
    .hidden {
      display: none !important;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fcfdff;
    }
    .panel h3 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    .preview-box {
      background: #f4f7fa;
      border-radius: 8px;
      overflow: auto;
      text-align: center;
      min-height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .preview-box img, .preview-box canvas {
      max-width: 100%;
      height: auto;
    }
    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      min-height: 20px;
    }
    @media (max-width: 780px) {
      .grid, .preview { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>QR ke AR Marker (.patt)</h1>
      <p>Upload gambar QR, lalu generate file marker PNG dan pattern <code>.patt</code> kompatibel AR.js.</p>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <label for="fileInput">Gambar QR</label>
          <input id="fileInput" type="file" accept="image/*" multiple />
        </div>
        <div>
          <label for="markerId">Nama file output (tanpa ekstensi)</label>
          <input id="markerId" type="text" value="marker" />
        </div>
        <div>
          <label for="patternRatio">Pattern Ratio (default AR.js 0.52)</label>
          <input id="patternRatio" type="number" min="0.1" max="0.9" step="0.01" value="0.52" />
        </div>
        <div>
          <label for="imageSize">Image size (px)</label>
          <input id="imageSize" type="number" min="200" max="2000" step="10" value="600" />
        </div>
        <div>
          <label for="borderColor">Border color</label>
          <input id="borderColor" type="color" value="#000000" />
        </div>
      </div>

      <div class="actions">
        <button id="btnGenerate" class="primary">Generate</button>
        <button id="btnDownloadMarker" disabled>Download Marker PNG</button>
        <button id="btnDownloadPatt" disabled>Download .patt</button>
        <button id="btnPdfOne" disabled>PDF 1/Page</button>
        <button id="btnPdfTwo" disabled>PDF 2/Page</button>
        <button id="btnPdfSix" disabled>PDF 6/Page</button>
      </div>
      <div class="status" id="statusText"></div>
    </section>

    <section class="card preview">
      <div class="panel">
        <h3>Preview Input</h3>
        <div class="preview-box" id="inputPreview"></div>
      </div>
      <div class="panel">
        <h3>Preview Marker Output</h3>
        <div class="preview-box" id="markerPreview"></div>
      </div>
    </section>

    <section class="card">
      <h3>Hasil Batch</h3>
      <p>Jika upload lebih dari 1 file, hasil akan tampil di sini.</p>
      <div class="actions">
        <button id="btnDownloadZip" class="primary" disabled>Download ZIP (Batch)</button>
      </div>
      <div id="resultsList" class="results"></div>
    </section>
  </main>

  <script src="assets/vendor/pdfMake/pdfmake.min.js"></script>
  <script src="assets/vendor/pdfMake/vfs_fonts.js"></script>
  <script src="assets/vendor/arjs/threex-arpatternfile.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const markerIdInput = document.getElementById("markerId");
    const patternRatioInput = document.getElementById("patternRatio");
    const imageSizeInput = document.getElementById("imageSize");
    const borderColorInput = document.getElementById("borderColor");
    const btnGenerate = document.getElementById("btnGenerate");
    const btnDownloadMarker = document.getElementById("btnDownloadMarker");
    const btnDownloadPatt = document.getElementById("btnDownloadPatt");
    const btnPdfOne = document.getElementById("btnPdfOne");
    const btnPdfTwo = document.getElementById("btnPdfTwo");
    const btnPdfSix = document.getElementById("btnPdfSix");
    const inputPreview = document.getElementById("inputPreview");
    const markerPreview = document.getElementById("markerPreview");
    const statusText = document.getElementById("statusText");
    const resultsList = document.getElementById("resultsList");
    const btnDownloadZip = document.getElementById("btnDownloadZip");

    let innerImageURL = null;
    let fullMarkerURL = null;
    let selectedItems = [];

    function setStatus(text) {
      statusText.textContent = text || "";
    }

    function renderInputPreview(file, srcUrl) {
      inputPreview.innerHTML = "";
      const img = new Image();
      img.alt = file.name;
      img.src = srcUrl;
      inputPreview.appendChild(img);
    }

    function renderInputPreviewList(items) {
      inputPreview.innerHTML = "";
      items.forEach((item) => {
        const img = new Image();
        img.alt = item.file.name;
        img.src = item.dataUrl;
        inputPreview.appendChild(img);
      });
    }

    function renderMarkerPreview(srcUrl) {
      markerPreview.innerHTML = "";
      const img = new Image();
      img.alt = "Marker";
      img.src = srcUrl;
      markerPreview.appendChild(img);
    }

    function safeFileBase() {
      return (markerIdInput.value || "marker")
        .trim()
        .replace(/[^a-zA-Z0-9_-]/g, "_")
        .replace(/_+/g, "_");
    }

    function safeFileBaseFromName(filename) {
      const base = filename.replace(/\.[^/.]+$/, "");
      return base.trim().replace(/[^a-zA-Z0-9_-]/g, "_").replace(/_+/g, "_");
    }

    function setDownloadState(enabled) {
      const disabled = !enabled;
      btnDownloadMarker.disabled = disabled;
      btnDownloadPatt.disabled = disabled;
      btnPdfOne.disabled = disabled;
      btnPdfTwo.disabled = disabled;
      btnPdfSix.disabled = disabled;
    }

    function setZipState(enabled) {
      btnDownloadZip.disabled = !enabled;
    }

    function updateGlobalActionsVisibility(isBatch) {
      const hide = Boolean(isBatch);
      btnDownloadMarker.classList.toggle("hidden", hide);
      btnDownloadPatt.classList.toggle("hidden", hide);
      btnPdfOne.classList.toggle("hidden", hide);
      btnPdfTwo.classList.toggle("hidden", hide);
      btnPdfSix.classList.toggle("hidden", hide);
      markerPreview.classList.toggle("hidden", hide);
      btnDownloadZip.classList.toggle("hidden", !hide);
    }

    function normalizeBorderColor(inputColor) {
      const value = String(inputColor || "").trim();
      const test = new Option().style;
      test.color = value;
      const isHex = /^#[0-9a-fA-F]{6}$/.test(value);
      if (!value || (test.color !== value && !isHex)) return "#000000";
      return value;
    }

    function renderResults() {
      resultsList.innerHTML = "";
      selectedItems.forEach((item) => {
        const card = document.createElement("div");
        card.className = "result-card";

        const title = document.createElement("h4");
        title.textContent = item.file.name;

        const img = document.createElement("img");
        img.className = "result-thumb";
        img.alt = item.file.name;
        img.src = item.markerUrl || item.dataUrl;

        const actions = document.createElement("div");
        actions.className = "result-actions";

        const btnPng = document.createElement("button");
        btnPng.textContent = "Download Marker PNG";
        btnPng.disabled = !item.markerUrl;
        btnPng.addEventListener("click", () => {
          if (!item.markerUrl) return;
          const base = safeFileBaseFromName(item.file.name);
          const a = document.createElement("a");
          a.href = item.markerUrl;
          a.download = `${base}-marker.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        });

        const btnPattItem = document.createElement("button");
        btnPattItem.textContent = "Download .patt";
        btnPattItem.disabled = !item.markerUrl;
        btnPattItem.addEventListener("click", () => {
          if (!item.dataUrl || !item.markerUrl) return;
          const base = safeFileBaseFromName(item.file.name);
          THREEx.ArPatternFile.encodeImageURL(item.dataUrl, function onComplete(patternFileString) {
            THREEx.ArPatternFile.triggerDownload(patternFileString, `${base}.patt`);
          });
        });

        const btnPdf1 = document.createElement("button");
        btnPdf1.textContent = "PDF 1/Page";
        btnPdf1.disabled = !item.markerUrl;
        btnPdf1.addEventListener("click", () => generatePdf(1, item.markerUrl));

        const btnPdf2 = document.createElement("button");
        btnPdf2.textContent = "PDF 2/Page";
        btnPdf2.disabled = !item.markerUrl;
        btnPdf2.addEventListener("click", () => generatePdf(2, item.markerUrl));

        const btnPdf6 = document.createElement("button");
        btnPdf6.textContent = "PDF 6/Page";
        btnPdf6.disabled = !item.markerUrl;
        btnPdf6.addEventListener("click", () => generatePdf(6, item.markerUrl));

        actions.appendChild(btnPng);
        actions.appendChild(btnPattItem);
        actions.appendChild(btnPdf1);
        actions.appendChild(btnPdf2);
        actions.appendChild(btnPdf6);

        card.appendChild(title);
        card.appendChild(img);
        card.appendChild(actions);
        resultsList.appendChild(card);
      });
    }
    function updateFullMarkerImage() {
      if (!innerImageURL) {
        setStatus("Pilih gambar QR terlebih dahulu.");
        return;
      }

      if (!window.THREEx || !THREEx.ArPatternFile) {
        setStatus("Library THREEx.ArPatternFile tidak ter-load.");
        return;
      }

      const patternRatio = Number(patternRatioInput.value);
      const imageSize = Number(imageSizeInput.value);
      if (!Number.isFinite(patternRatio) || patternRatio <= 0 || patternRatio >= 1) {
        setStatus("Pattern Ratio harus di antara 0 dan 1.");
        return;
      }
      if (!Number.isFinite(imageSize) || imageSize < 200) {
        setStatus("Image size minimal 200.");
        return;
      }

      const borderColor = normalizeBorderColor(borderColorInput.value);
      borderColorInput.value = borderColor.startsWith("#") ? borderColor : "#000000";

      THREEx.ArPatternFile.buildFullMarker(
        innerImageURL,
        patternRatio,
        Math.floor(imageSize),
        borderColor,
        function onComplete(markerUrl) {
          fullMarkerURL = markerUrl;
          renderMarkerPreview(markerUrl);
          setDownloadState(true);
          setStatus("Generate selesai. Silakan download marker PNG, .patt, atau PDF.");
        }
      );
    }

    function generatePdf(mode, markerUrlOverride) {
      const markerUrl = markerUrlOverride || fullMarkerURL;
      if (!markerUrl || !window.pdfMake) return;

      let docDefinition;
      if (mode === 1) {
        docDefinition = {
          content: [{ image: markerUrl, width: 600, alignment: "center" }]
        };
      } else if (mode === 2) {
        docDefinition = {
          content: [
            { image: markerUrl, width: 300, alignment: "center" },
            { image: markerUrl, width: 300, alignment: "center" }
          ]
        };
      } else {
        docDefinition = {
          content: [
            { columns: [{ image: markerUrl, width: 250 }, { image: markerUrl, width: 250 }] },
            { columns: [{ image: markerUrl, width: 250 }, { image: markerUrl, width: 250 }] },
            { columns: [{ image: markerUrl, width: 250 }, { image: markerUrl, width: 250 }] }
          ]
        };
      }
      pdfMake.createPdf(docDefinition).open();
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    fileInput.addEventListener("change", async () => {
      innerImageURL = null;
      fullMarkerURL = null;
      setDownloadState(false);
      setZipState(false);
      markerPreview.innerHTML = "";
      resultsList.innerHTML = "";
      selectedItems = [];

      const files = Array.from(fileInput.files || []);
      if (!files.length) {
        inputPreview.innerHTML = "";
        setStatus("");
        updateGlobalActionsVisibility(false);
        return;
      }

      if (files.length > 1) {
        updateGlobalActionsVisibility(true);
        setStatus(`Membaca ${files.length} file...`);
        try {
          const dataUrls = await Promise.all(files.map((file) => readFileAsDataURL(file)));
          selectedItems = files.map((file, index) => ({
            file,
            dataUrl: dataUrls[index],
            markerUrl: null
          }));
          renderInputPreviewList(selectedItems);
          renderResults();
          setStatus("Semua file siap. Klik Generate untuk batch.");
        } catch (error) {
          console.error(error);
          setStatus("Gagal membaca salah satu file.");
        }
        return;
      }

      updateGlobalActionsVisibility(false);
      const file = files[0];
      try {
        innerImageURL = await readFileAsDataURL(file);
        renderInputPreview(file, innerImageURL);
        setStatus("Gambar siap. Klik Generate.");
      } catch (error) {
        console.error(error);
        setStatus("Gagal membaca file.");
      }
    });

    btnGenerate.addEventListener("click", async () => {
      if (selectedItems.length > 1) {
        if (!window.THREEx || !THREEx.ArPatternFile) {
          setStatus("Library THREEx.ArPatternFile tidak ter-load.");
          return;
        }
        const patternRatio = Number(patternRatioInput.value);
        const imageSize = Number(imageSizeInput.value);
        if (!Number.isFinite(patternRatio) || patternRatio <= 0 || patternRatio >= 1) {
          setStatus("Pattern Ratio harus di antara 0 dan 1.");
          return;
        }
        if (!Number.isFinite(imageSize) || imageSize < 200) {
          setStatus("Image size minimal 200.");
          return;
        }
        const borderColor = normalizeBorderColor(borderColorInput.value);
        borderColorInput.value = borderColor.startsWith("#") ? borderColor : "#000000";

        setStatus("Generate batch dimulai...");
        for (const item of selectedItems) {
          await new Promise((resolve) => {
            THREEx.ArPatternFile.buildFullMarker(
              item.dataUrl,
              patternRatio,
              Math.floor(imageSize),
              borderColor,
              function onComplete(markerUrl) {
                item.markerUrl = markerUrl;
                resolve();
              }
            );
          });
        }
        renderResults();
        setZipState(true);
        setStatus("Generate batch selesai. Silakan download per file.");
        return;
      }

      updateFullMarkerImage();
    });

    btnDownloadZip.addEventListener("click", async () => {
      if (!window.JSZip) {
        setStatus("Library JSZip tidak ter-load.");
        return;
      }
      if (!selectedItems.length) return;
      const notReady = selectedItems.some((item) => !item.markerUrl);
      if (notReady) {
        setStatus("Generate batch terlebih dahulu sebelum download ZIP.");
        return;
      }

      setStatus("Membuat ZIP...");
      const zip = new JSZip();
      for (const item of selectedItems) {
        const base = safeFileBaseFromName(item.file.name);
        const markerData = String(item.markerUrl || "");
        const markerBase64 = markerData.includes(",") ? markerData.split(",")[1] : markerData;
        zip.file(`${base}-marker.png`, markerBase64, { base64: true });
        await new Promise((resolve) => {
          THREEx.ArPatternFile.encodeImageURL(item.dataUrl, function onComplete(patternFileString) {
            zip.file(`${base}.patt`, patternFileString);
            resolve();
          });
        });
      }

      const blob = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "markers-batch.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("ZIP siap diunduh.");
    });

    btnDownloadMarker.addEventListener("click", () => {
      if (!fullMarkerURL) return;
      const base = safeFileBase();
      const a = document.createElement("a");
      a.href = fullMarkerURL;
      a.download = `${base}-marker.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnDownloadPatt.addEventListener("click", () => {
      if (!innerImageURL) return;
      const base = safeFileBase();
      THREEx.ArPatternFile.encodeImageURL(innerImageURL, function onComplete(patternFileString) {
        THREEx.ArPatternFile.triggerDownload(patternFileString, `${base}.patt`);
      });
    });

    btnPdfOne.addEventListener("click", () => generatePdf(1));
    btnPdfTwo.addEventListener("click", () => generatePdf(2));
    btnPdfSix.addEventListener("click", () => generatePdf(6));

    patternRatioInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
    imageSizeInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
    borderColorInput.addEventListener("input", () => {
      if (innerImageURL) updateFullMarkerImage();
    });
  </script>
</body>
</html>
