<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="description" content="Sistem Informasi Tanaman Obat Keluarga (TOGA) berbasis QR Code untuk RT 09 PKK. Temukan informasi lengkap tentang tanaman obat keluarga, manfaat, dan cara penggunaannya dengan mudah melalui pemindaian QR Code." />
    <title>AR TOGA</title>
    <meta name="theme-color" content="#1f7a3e" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="TOGA AR" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="assets/icons/icon-192.png" type="image/png" />
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
    <link rel="apple-touch-startup-image" href="assets/screenshots/install-mobile.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" /></noscript>
    <script>
      (function () {
        var splashKey = "toga:splash:shown";
        var installed =
          (typeof window.matchMedia === "function" &&
            window.matchMedia("(display-mode: standalone)").matches) ||
          window.navigator.standalone === true ||
          document.referrer.indexOf("android-app://") === 0;
        var ua = window.navigator.userAgent || "";
        var isiOS = /iphone|ipad|ipod/i.test(ua);
        document.documentElement.classList.add(installed ? "pwa-installed" : "pwa-browser");
        if (isiOS) {
          document.documentElement.classList.add("ios-webkit");
        }
        try {
          var isInternalNav = document.referrer.indexOf(window.location.origin) === 0;
          if (!isInternalNav) {
            sessionStorage.removeItem(splashKey);
          }
          var splashShown = sessionStorage.getItem(splashKey) === "1";
          if (splashShown) {
            document.documentElement.classList.add("pwa-splash-skip");
          } else if (installed) {
            document.documentElement.classList.add("pwa-launch-pending");
          }
        } catch (_) {}
      })();
    </script>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
      #pwaBootSplash {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        place-items: center;
        background: linear-gradient(150deg, #10352a, #1f7a3e);
        color: #f3fbf8;
        font-family: "Plus Jakarta Sans", "Segoe UI", sans-serif;
        opacity: 1;
        transition: opacity 0.32s ease;
      }
      @media (display-mode: standalone) {
        #pwaBootSplash {
          display: grid;
        }
      }
      html.pwa-installed #pwaBootSplash {
        display: grid;
      }
      html.pwa-splash-skip #pwaBootSplash {
        display: none !important;
      }
      html.pwa-browser #pwaBootSplash {
        display: none !important;
      }
      html.pwa-launch-pending #pwaBootSplash {
        display: grid !important;
        opacity: 1 !important;
      }
      html.pwa-launch-pending body > :not(#pwaBootSplash) {
        visibility: hidden;
      }
      html.ios-webkit.pwa-launch-pending body > :not(#pwaBootSplash),
      html.ios-webkit.pwa-launch-pending body > :not(#pwaBootSplash) * {
        animation: none !important;
        transition: none !important;
      }
      #pwaBootSplash.is-hide {
        opacity: 0;
        pointer-events: none;
      }
      .pwa-launch-splash__inner {
        display: grid;
        justify-items: center;
        gap: 10px;
        text-align: center;
        padding: 18px;
      }
      .pwa-launch-splash__logo {
        width: 72px;
        height: 72px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.26);
        background: rgba(255, 255, 255, 0.16);
        object-fit: cover;
        animation: pwaLogoPulse 1.4s ease-in-out infinite;
      }
      .pwa-launch-splash__title {
        font-size: 16px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .pwa-launch-splash__loading {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: rgba(243, 251, 248, 0.92);
      }
      .pwa-launch-splash__spinner {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.28);
        border-top-color: #ffffff;
        animation: pwaSpin 0.9s linear infinite;
      }
      @keyframes pwaSpin {
        to { transform: rotate(360deg); }
      }
      @keyframes pwaLogoPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.045); }
      }
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .hud {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        z-index: 10;
        padding: 10px 12px;
        color: #fff;
        background: rgba(0, 0, 0, 0.45);
        font-size: 14px;
      }
      .btn {
        position: fixed;
        left: 14px;
        right: 14px;
        bottom: 14px;
        z-index: 10;
        padding: 12px 14px;
        border-radius: 12px;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        text-decoration: none;
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.25);
        display: none;
      }
      .btn-back {
        background: rgba(7, 27, 29, 0.7);
      }
      .debug-panel {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 76px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 10px;
        color: #fff;
        display: none;
      }
      .debug-title {
        font-size: 12px;
        font-weight: 700;
        margin: 0 0 8px;
        opacity: 0.9;
      }
      .debug-row {
        display: flex;
        gap: 8px;
      }
      .debug-select,
      .debug-btn {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 12px;
      }
      .debug-select {
        flex: 1;
      }
      .debug-btn {
        font-weight: 700;
      }

    </style>
  </head>

  <body>
    <div id="pwaBootSplash" class="pwa-launch-splash" aria-hidden="true">
      <div class="pwa-launch-splash__inner">
        <img class="pwa-launch-splash__logo" src="assets/icons/icon-192.png" alt="Logo TOGA" />
        <div class="pwa-launch-splash__title">TOGA RT 09</div>
        <div class="pwa-launch-splash__loading">
          <span class="pwa-launch-splash__spinner" aria-hidden="true"></span>
          <span>Memuat aplikasi...</span>
        </div>
      </div>
    </div>
    <div class="hud" id="hud">AR TOGA • Arahkan kamera ke marker pattern</div>
    <a class="btn btn-back" id="btnBack" href="./">Kembali</a>
    <a class="btn" id="btnDetail" href="#" target="_blank" rel="noopener"
      >Detail tanaman</a
    >

    <div class="debug-panel" id="debugPanel">
      <p class="debug-title">DEBUG MODE • Simulasi marker</p>

      <div class="debug-row">
        <select id="debugSelect" class="debug-select"></select>
      </div>

      <div class="debug-row" style="margin-top: 8px">
        <button id="debugFound" class="debug-btn" type="button">Found</button>
        <button id="debugLost" class="debug-btn" type="button">Lost</button>
        <button id="debugReset" class="debug-btn" type="button">Reset</button>
      </div>

      <div class="debug-row" style="margin-top: 8px">
        <button id="debugExport" class="debug-btn" type="button">
          Export JSON
        </button>
        <button id="debugClear" class="debug-btn" type="button">
          Clear Log
        </button>
      </div>

      <pre
        id="debugLog"
        style="margin-top:8px; max-height:180px; overflow:auto; background:rgba(0,0,0,0.45); padding:8px; border-radius:8px; font-size:12px;"
      >[]</pre>
    </div>

    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true;"
      arjs="sourceType: webcam; debugUIEnabled:false;"
    >
      <a-entity camera></a-entity>
      <a-assets id="assets"></a-assets>
      <a-entity id="root"></a-entity>
    </a-scene>

    <script>
      // Samakan dengan pola app.js agar endpoint lebih konsisten
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzNJ5nbk41yTxowEorHZendyeW-TvgzfdnnpyTMHGEayTW1KE7zQuk0GHe6fjAQmkukUg/exec";
      const LOCAL_DATA_URL = "data/plants.json";
      const FETCH_TIMEOUT_MS = 12000;
      const CACHE_TTL_MS = 10 * 60 * 1000;
      const CACHE_KEY_LIST = "toga:plants:list:v1";
      const CACHE_KEY_AR_LIST = "toga:ar:plants:full:v1";

      const PLACEHOLDER_SVG_DATA =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400">
            <rect fill="#dddddd" width="100%" height="100%"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-size="28">TOGA</text>
          </svg>`
        );

      const LOST_DEBOUNCE_MS = 350;
      const DEBUG_MODE =
        new URLSearchParams(window.location.search).get("debug") === "1";

      const hud = document.getElementById("hud");
      const btnBack = document.getElementById("btnBack");
      const btn = document.getElementById("btnDetail");
      const root = document.getElementById("root");

      const debugPanel = document.getElementById("debugPanel");
      const debugSelect = document.getElementById("debugSelect");
      const debugFoundBtn = document.getElementById("debugFound");
      const debugLostBtn = document.getElementById("debugLost");
      const debugResetBtn = document.getElementById("debugReset");
      const debugExportBtn = document.getElementById("debugExport");
      const debugClearBtn = document.getElementById("debugClear");
      const debugLogEl = document.getElementById("debugLog");

      const activeMarkers = new Map();
      const lostTimers = new Map();
      const plantById = new Map();
      const debugEvents = [];

      updateActiveUI();

      function logDebug(event, payload = {}) {
        if (!DEBUG_MODE) return;
        debugEvents.push({
          t: new Date().toISOString(),
          event,
          ...payload,
        });
        debugLogEl.textContent = JSON.stringify(debugEvents, null, 2);
      }

      function normalizeList(value) {
        if (Array.isArray(value)) {
          return value.map((x) => safeStr(x).trim()).filter(Boolean);
        }

        if (typeof value === "string") {
          return value
            .split(/\r?\n|;|\|/)
            .map((x) => x.trim())
            .filter(Boolean);
        }

        return [];
      }

      function firstBullets(arr, n = 3) {
        let arrData = normalizeList(arr);
        return arrData.slice(0, n).map((x) => `• ${x}`).join("\n");
      }

      function safeStr(v) {
        return v === null || v === undefined ? "" : String(v);
      }

      function isHttpUrl(url) {
        return /^https?:\/\//i.test(url || "");
      }

      function resolveImageSrc(gambar) {
        const src = safeStr(gambar).trim();
        if (!src) return PLACEHOLDER_SVG_DATA;

        // jika absolute http(s), pakai langsung
        if (isHttpUrl(src)) return src;

        // jika data URL (base64 / svg)
        if (/^data:/i.test(src)) return src;

        // selain itu dianggap path lokal relatif
        // contoh: "images/jahe.jpg" atau "./images/jahe.jpg"
        return src.replace(/^\.\//, "");
      }

      async function fetchJSON(url) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

        try {
          const res = await fetch(url, {
            cache: "default",
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } finally {
          clearTimeout(timer);
        }
      }

      function readCache(key, ttlMs = CACHE_TTL_MS) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return null;
          const age = Date.now() - Number(parsed.ts || 0);
          if (age > ttlMs) return null;
          return parsed.data;
        } catch (_) {
          return null;
        }
      }

      function writeCache(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data }));
        } catch (_) {}
      }

      function clearLostTimer(id) {
        const timer = lostTimers.get(id);
        if (!timer) return;
        clearTimeout(timer);
        lostTimers.delete(id);
      }

      function updateActiveUI() {
        const top = activeMarkers.values().next().value;
        if (!top) {
          hud.textContent = "AR TOGA • Arahkan kamera ke marker pattern";
          btn.style.display = "none";
          btnBack.style.display = "block";
          btn.href = "#";
          btn.textContent = "Detail tanaman";
          return;
        }

        hud.textContent = `Marker terdeteksi: ${top.nama}`;
        btnBack.style.display = "none";
        btn.href = top.detailUrl;
        btn.textContent = `Detail ${top.nama}`;
        btn.style.display = "block";
      }

      function setMarkerFound(id, nama, detailUrl) {
        clearLostTimer(id);
        activeMarkers.set(id, { nama, detailUrl });
        updateActiveUI();
        logDebug("markerFound", { id, nama });
      }

      function setMarkerLost(id) {
        clearLostTimer(id);
        const timer = setTimeout(() => {
          activeMarkers.delete(id);
          lostTimers.delete(id);
          updateActiveUI();
          logDebug("markerLost", { id });
        }, LOST_DEBOUNCE_MS);
        lostTimers.set(id, timer);
      }

      function ensureImageAsset(id, gambar) {
        const assetsEl = document.getElementById("assets");
        const assetId = `img_${id}`;
        if (document.getElementById(assetId)) return assetId;

        const imgAsset = document.createElement("img");
        imgAsset.id = assetId;

        const srcUrl = resolveImageSrc(gambar);

        // crossOrigin hanya untuk http(s)
        if (isHttpUrl(srcUrl)) imgAsset.crossOrigin = "anonymous";

        imgAsset.src = srcUrl;

        imgAsset.onload = () => {
          console.debug("Image asset loaded:", assetId, srcUrl);
          logDebug("imgLoaded", { id, srcUrl });
        };

        imgAsset.onerror = () => {
          console.warn("Image failed (or CORS blocked):", srcUrl, "fallback placeholder");
          logDebug("imgError", { id, srcUrl });
          imgAsset.onerror = null;
          imgAsset.removeAttribute("crossorigin");
          imgAsset.src = PLACEHOLDER_SVG_DATA;
        };

        assetsEl.appendChild(imgAsset);
        return assetId;
      }

      function makeMarker(plant) {
        const id = safeStr(plant.id).trim();
        if (!id) return null;

        const nama = safeStr(plant.nama || id);
        const gambar = safeStr(plant.gambar || "");
        const manfaat = plant.manfaat || "";
        const detailUrl = `./?id=${encodeURIComponent(id)}`;

        const marker = document.createElement("a-marker");
        marker.setAttribute("type", "pattern");
        marker.setAttribute("url", `markers/${encodeURIComponent(id)}.patt`);
        marker.setAttribute("id", `m_${id}`);
        marker.setAttribute("smooth", "true");
        marker.setAttribute("smoothCount", "10");
        marker.setAttribute("smoothTolerance", "0.01");
        marker.setAttribute("smoothThreshold", "5");

        const panel = document.createElement("a-plane");
        panel.setAttribute("position", "0 0.6 0");
        panel.setAttribute("rotation", "-90 0 0");
        panel.setAttribute("width", "2.6");
        panel.setAttribute("height", "1.5");
        panel.setAttribute("material", "color:#000; opacity:0.45");
        marker.appendChild(panel);

        const assetId = ensureImageAsset(id, gambar);

        const img = document.createElement("a-image");
        img.setAttribute("position", "-0.6 0.8 0.01");
        img.setAttribute("rotation", "-90 0 0");
        img.setAttribute("width", "1.1");
        img.setAttribute("height", "1.1");
        img.setAttribute("src", `#${assetId}`);
        marker.appendChild(img);

        const txtName = document.createElement("a-text");
        txtName.setAttribute("position", "0.037 0.8 -0.399");
        txtName.setAttribute("rotation", "-90 0 0");
        txtName.setAttribute("value", nama.toUpperCase());
        txtName.setAttribute("width", "1.4");
        txtName.setAttribute("align", "left");
        txtName.setAttribute("wrap-count", "18");
        txtName.setAttribute("color", "#FFFFFF");
        txtName.setAttribute("outline-color", "#000000");
        txtName.setAttribute("outline-width", "4");
        marker.appendChild(txtName);

        const txtInfo = document.createElement("a-text");
        txtInfo.setAttribute("position", "0.037 0.8 -0.200");
        txtInfo.setAttribute("rotation", "-90 0 0");
        txtInfo.setAttribute("value", firstBullets(manfaat, 4));
        txtInfo.setAttribute("width", "1.4");
        txtInfo.setAttribute("align", "left");
        txtInfo.setAttribute("baseline", "top");
        txtInfo.setAttribute("wrap-count", "28");
        txtInfo.setAttribute("color", "#E8F5FF");
        txtInfo.setAttribute("outline-color", "#000000");
        txtInfo.setAttribute("outline-width", "3");
        marker.appendChild(txtInfo);

        marker.addEventListener("markerFound", () =>
          setMarkerFound(id, nama, detailUrl)
        );
        marker.addEventListener("markerLost", () => setMarkerLost(id));

        return marker;
      }

      function setupDebugMode(plants) {
        if (!DEBUG_MODE || !debugPanel || !debugSelect) return;

        debugPanel.style.display = "block";
        debugSelect.innerHTML = "";
        debugEvents.length = 0;
        debugLogEl.textContent = "[]";

        plants.forEach((p) => {
          const id = safeStr(p.id).trim();
          if (!id) return;
          const nama = safeStr(p.nama || id);
          const detailUrl = `./?id=${encodeURIComponent(id)}`;
          plantById.set(id, { id, nama, detailUrl });

          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `${nama} (${id})`;
          debugSelect.appendChild(opt);
        });

        // FIX: debugZSelect -> debugSelect
        debugFoundBtn.onclick = () => {
          const id = debugSelect.value;
          const plant = plantById.get(id);
          if (!plant) return;
          setMarkerFound(plant.id, plant.nama, plant.detailUrl);
        };

        debugLostBtn.onclick = () => {
          const id = debugSelect.value;
          if (!id) return;
          setMarkerLost(id);
        };

        debugResetBtn.onclick = () => {
          Array.from(lostTimers.keys()).forEach((id) => clearLostTimer(id));
          activeMarkers.clear();
          updateActiveUI();
          logDebug("reset");
        };

        debugExportBtn.onclick = async () => {
          const json = JSON.stringify(debugEvents, null, 2);
          try {
            await navigator.clipboard.writeText(json);
            alert("Log debug disalin ke clipboard.");
          } catch (_) {
            window.prompt("Copy JSON ini:", json);
          }
        };

        debugClearBtn.onclick = () => {
          debugEvents.length = 0;
          debugLogEl.textContent = "[]";
        };
      }

      async function loadPlants() {
        const cached = readCache(CACHE_KEY_AR_LIST);
        const cachedPlants = Array.isArray(cached)
          ? cached
          : Object.values(cached || {});
        if (cachedPlants.length > 0) {
          // AR butuh field manfaat/cara/catatan, jadi ambil dataset full.
          fetchJSON(`${API_URL}`)
            .then((dataset) => {
              const plants = Array.isArray(dataset)
                ? dataset
                : Object.values(dataset || {});
              if (plants.length > 0) writeCache(CACHE_KEY_AR_LIST, plants);
            })
            .catch(() => {});
          return cachedPlants;
        }

        // AR mode: ambil data full agar text manfaat bisa tampil.
        try {
          const dataset = await fetchJSON(`${API_URL}`);
          const plants = Array.isArray(dataset)
            ? dataset
            : Object.values(dataset || {});
          if (plants.length > 0) {
            writeCache(CACHE_KEY_AR_LIST, plants);
            return plants;
          }
        } catch (error) {
          console.warn("Remote API gagal, fallback ke data lokal", error);
        }

        const local = await fetchJSON(LOCAL_DATA_URL);
        return Array.isArray(local) ? local : Object.values(local || {});
      }

      async function main() {
        hud.textContent = "AR TOGA • Memuat data tanaman...";
        try {
          const plants = await loadPlants();

          if (!plants.length) {
            hud.textContent = "AR TOGA • Data tanaman kosong";
            return;
          }

          plants.forEach((p) => {
            const marker = makeMarker(p);
            if (marker) root.appendChild(marker);
          });

          setupDebugMode(plants);
          hud.textContent = "AR TOGA • Siap. Arahkan kamera ke marker pattern.";
        } catch (e) {
          console.error(e);
          hud.textContent =
            "AR TOGA • Gagal memuat data (cek koneksi/API/data lokal).";
        }
      }

      main();
    </script>
    <script src="assets/pwa.js" defer></script>
  </body>
</html>
