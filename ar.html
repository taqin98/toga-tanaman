<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>AR TOGA</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial;
      }
      .hud {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        z-index: 10;
        padding: 10px 12px;
        color: #fff;
        background: rgba(0, 0, 0, 0.45);
        font-size: 14px;
      }
      .btn {
        position: fixed;
        left: 14px;
        right: 14px;
        bottom: 14px;
        z-index: 10;
        padding: 12px 14px;
        border-radius: 12px;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        text-decoration: none;
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.25);
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="hud" id="hud">AR TOGA • Arahkan kamera ke QR tanaman</div>
    <a class="btn" id="btnDetail" href="#" target="_blank" rel="noopener"
      >Detail tanaman</a
    >

    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true;"
      arjs="sourceType: webcam; debugUIEnabled:false;"
    >
      <a-entity camera></a-entity>

      <!-- Marker + panel akan di-generate lewat JS -->
      <a-entity id="root"></a-entity>
    </a-scene>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzNJ5nbk41yTxowEorHZendyeW-TvgzfdnnpyTMHGEayTW1KE7zQuk0GHe6fjAQmkukUg/exec";

      const hud = document.getElementById("hud");
      const btn = document.getElementById("btnDetail");
      const root = document.getElementById("root");

      function firstBullets(arr, n = 3) {
        if (!Array.isArray(arr)) return "";
        return arr
          .slice(0, n)
          .map((x) => `• ${x}`)
          .join("\n");
      }

      function safeStr(v) {
        return v === null || v === undefined ? "" : String(v);
      }

      async function fetchJSON(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("Fetch gagal");
        return await res.json();
      }

    function makeMarker(plant){
  const id = safeStr(plant.id).trim();
  if(!id) return null;

  const nama = safeStr(plant.nama || id);
  const gambar = safeStr(plant.gambar || "");
  const manfaat = plant.manfaat || [];
  const detailUrl = `./?id=${encodeURIComponent(id)}`;

  const marker = document.createElement("a-marker");
  marker.setAttribute("type", "pattern");
  marker.setAttribute("url", `markers/${encodeURIComponent(id)}.patt`);
  marker.setAttribute("id", `m_${id}`);

  // smoothing lebih kuat
  marker.setAttribute("smooth", "true");
  marker.setAttribute("smoothCount", "20");
  marker.setAttribute("smoothTolerance", "0.01");
  marker.setAttribute("smoothThreshold", "5");

  // ===== WRAPPER ENTITY (biar stabil) =====
  const wrapper = document.createElement("a-entity");
  wrapper.setAttribute("position", "0 0.5 0");

  // background panel (lebih kecil)
  const panel = document.createElement("a-plane");
  panel.setAttribute("width", "1.8");
  panel.setAttribute("height", "1.0");
  panel.setAttribute("material", "color:#000; opacity:0.55");
  wrapper.appendChild(panel);

  // image (dipusatkan)
  const img = document.createElement("a-image");
  img.setAttribute("position", "-0.45 0 0.01");
  img.setAttribute("width", "0.7");
  img.setAttribute("height", "0.7");
  img.setAttribute("src", gambar || "https://via.placeholder.com/300");
  wrapper.appendChild(img);

  // name
  const txtName = document.createElement("a-text");
  txtName.setAttribute("position", "0.35 0.25 0.02");
  txtName.setAttribute("value", nama.toUpperCase());
  txtName.setAttribute("width", "1.4");
  txtName.setAttribute("align", "left");
  txtName.setAttribute("color", "#FFFFFF");
  wrapper.appendChild(txtName);

  // info
  const txtInfo = document.createElement("a-text");
  txtInfo.setAttribute("position", "0.35 -0.15 0.02");
  txtInfo.setAttribute("value", firstBullets(manfaat, 2));
  txtInfo.setAttribute("width", "1.4");
  txtInfo.setAttribute("align", "left");
  txtInfo.setAttribute("color", "#E8F5FF");
  wrapper.appendChild(txtInfo);

  marker.appendChild(wrapper);

  marker.addEventListener("markerFound", () => {
    hud.textContent = `Marker terdeteksi: ${nama}`;
    btn.href = detailUrl;
    btn.style.display = "block";
  });

  marker.addEventListener("markerLost", () => {
    hud.textContent = "AR TOGA • Arahkan kamera ke QR tanaman";
    btn.style.display = "none";
  });

  return marker;
}


    async function main() {
        hud.textContent = "AR TOGA • Memuat data tanaman...";
        try {
          // Ambil full dataset: {id:{...}, id2:{...}}
          const dataset = await fetchJSON(API_URL);
          const plants = Object.values(dataset || {});

          if (!plants.length) {
            hud.textContent = "AR TOGA • Data tanaman kosong";
            return;
          }

          plants.forEach((p) => {
            const marker = makeMarker(p);
            if (marker) root.appendChild(marker);
          });

          hud.textContent = "AR TOGA • Siap. Arahkan kamera ke QR tanaman.";
        } catch (e) {
          console.error(e);
          hud.textContent = "AR TOGA • Gagal memuat data (cek koneksi/API).";
        }
    }

    main();
    </script>
  </body>
</html>
