<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>AR TOGA</title>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .hud {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        z-index: 10;
        padding: 10px 12px;
        color: #fff;
        background: rgba(0, 0, 0, 0.45);
        font-size: 14px;
      }
      .btn {
        position: fixed;
        left: 14px;
        right: 14px;
        bottom: 14px;
        z-index: 10;
        padding: 12px 14px;
        border-radius: 12px;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        text-decoration: none;
        font-weight: 800;
        border: 1px solid rgba(255, 255, 255, 0.25);
        display: none;
      }
      .debug-panel {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 76px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 10px;
        color: #fff;
        display: none;
      }
      .debug-title {
        font-size: 12px;
        font-weight: 700;
        margin: 0 0 8px;
        opacity: 0.9;
      }
      .debug-row {
        display: flex;
        gap: 8px;
      }
      .debug-select,
      .debug-btn {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 12px;
      }
      .debug-select {
        flex: 1;
      }
      .debug-btn {
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <div class="hud" id="hud">AR TOGA • Arahkan kamera ke marker pattern</div>
    <a class="btn" id="btnDetail" href="#" target="_blank" rel="noopener"
      >Detail tanaman</a
    >

    <div class="debug-panel" id="debugPanel">
      <p class="debug-title">DEBUG MODE • Simulasi marker</p>

      <div class="debug-row">
        <select id="debugSelect" class="debug-select"></select>
      </div>

      <div class="debug-row" style="margin-top: 8px">
        <button id="debugFound" class="debug-btn" type="button">Found</button>
        <button id="debugLost" class="debug-btn" type="button">Lost</button>
        <button id="debugReset" class="debug-btn" type="button">Reset</button>
      </div>

      <div class="debug-row" style="margin-top: 8px">
        <button id="debugExport" class="debug-btn" type="button">
          Export JSON
        </button>
        <button id="debugClear" class="debug-btn" type="button">
          Clear Log
        </button>
      </div>

      <pre
        id="debugLog"
        style="margin-top:8px; max-height:180px; overflow:auto; background:rgba(0,0,0,0.45); padding:8px; border-radius:8px; font-size:12px;"
      >[]</pre>
    </div>

    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true;"
      arjs="sourceType: webcam; debugUIEnabled:false;"
    >
      <a-entity camera></a-entity>
      <a-assets id="assets"></a-assets>
      <a-entity id="root"></a-entity>
    </a-scene>

    <script>
      // Samakan dengan pola app.js agar endpoint lebih konsisten
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzNJ5nbk41yTxowEorHZendyeW-TvgzfdnnpyTMHGEayTW1KE7zQuk0GHe6fjAQmkukUg/exec";
      const LOCAL_DATA_URL = "data/plants.json";
      const FETCH_TIMEOUT_MS = 12000;

      const PLACEHOLDER_SVG_DATA =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400">
            <rect fill="#dddddd" width="100%" height="100%"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#666" font-size="28">TOGA</text>
          </svg>`
        );

      const LOST_DEBOUNCE_MS = 350;
      const DEBUG_MODE =
        new URLSearchParams(window.location.search).get("debug") === "1";

      const hud = document.getElementById("hud");
      const btn = document.getElementById("btnDetail");
      const root = document.getElementById("root");

      const debugPanel = document.getElementById("debugPanel");
      const debugSelect = document.getElementById("debugSelect");
      const debugFoundBtn = document.getElementById("debugFound");
      const debugLostBtn = document.getElementById("debugLost");
      const debugResetBtn = document.getElementById("debugReset");
      const debugExportBtn = document.getElementById("debugExport");
      const debugClearBtn = document.getElementById("debugClear");
      const debugLogEl = document.getElementById("debugLog");

      const activeMarkers = new Map();
      const lostTimers = new Map();
      const plantById = new Map();
      const debugEvents = [];

      function logDebug(event, payload = {}) {
        if (!DEBUG_MODE) return;
        debugEvents.push({
          t: new Date().toISOString(),
          event,
          ...payload,
        });
        debugLogEl.textContent = JSON.stringify(debugEvents, null, 2);
      }

      function firstBullets(arr, n = 3) {
        let arrData = normalizeList(arr);
        return arrData.slice(0, n).map((x) => `• ${x}`).join("\n");
      }

      function safeStr(v) {
        return v === null || v === undefined ? "" : String(v);
      }

      function isHttpUrl(url) {
        return /^https?:\/\//i.test(url || "");
      }

      function resolveImageSrc(gambar) {
        const src = safeStr(gambar).trim();
        if (!src) return PLACEHOLDER_SVG_DATA;

        // jika absolute http(s), pakai langsung
        if (isHttpUrl(src)) return src;

        // jika data URL (base64 / svg)
        if (/^data:/i.test(src)) return src;

        // selain itu dianggap path lokal relatif
        // contoh: "images/jahe.jpg" atau "./images/jahe.jpg"
        return src.replace(/^\.\//, "");
      }

      async function fetchJSON(url) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

        try {
          const res = await fetch(url, {
            cache: "no-store",
            signal: controller.signal,
            headers: { Accept: "application/json" },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } finally {
          clearTimeout(timer);
        }
      }

      function clearLostTimer(id) {
        const timer = lostTimers.get(id);
        if (!timer) return;
        clearTimeout(timer);
        lostTimers.delete(id);
      }

      function updateActiveUI() {
        const top = activeMarkers.values().next().value;
        if (!top) {
          hud.textContent = "AR TOGA • Arahkan kamera ke marker pattern";
          btn.style.display = "none";
          btn.href = "#";
          btn.textContent = "Detail tanaman";
          return;
        }

        hud.textContent = `Marker terdeteksi: ${top.nama}`;
        btn.href = top.detailUrl;
        btn.textContent = `Detail ${top.nama}`;
        btn.style.display = "block";
      }

      function setMarkerFound(id, nama, detailUrl) {
        clearLostTimer(id);
        activeMarkers.set(id, { nama, detailUrl });
        updateActiveUI();
        logDebug("markerFound", { id, nama });
      }

      function setMarkerLost(id) {
        clearLostTimer(id);
        const timer = setTimeout(() => {
          activeMarkers.delete(id);
          lostTimers.delete(id);
          updateActiveUI();
          logDebug("markerLost", { id });
        }, LOST_DEBOUNCE_MS);
        lostTimers.set(id, timer);
      }

      function ensureImageAsset(id, gambar) {
        const assetsEl = document.getElementById("assets");
        const assetId = `img_${id}`;
        if (document.getElementById(assetId)) return assetId;

        const imgAsset = document.createElement("img");
        imgAsset.id = assetId;

        const srcUrl = resolveImageSrc(gambar);

        // crossOrigin hanya untuk http(s)
        if (isHttpUrl(srcUrl)) imgAsset.crossOrigin = "anonymous";

        imgAsset.src = srcUrl;

        imgAsset.onload = () => {
          console.debug("Image asset loaded:", assetId, srcUrl);
          logDebug("imgLoaded", { id, srcUrl });
        };

        imgAsset.onerror = () => {
          console.warn("Image failed (or CORS blocked):", srcUrl, "fallback placeholder");
          logDebug("imgError", { id, srcUrl });
          imgAsset.onerror = null;
          imgAsset.removeAttribute("crossorigin");
          imgAsset.src = PLACEHOLDER_SVG_DATA;
        };

        assetsEl.appendChild(imgAsset);
        return assetId;
      }

      function makeMarker(plant) {
        const id = safeStr(plant.id).trim();
        if (!id) return null;

        const nama = safeStr(plant.nama || id);
        const gambar = safeStr(plant.gambar || "");
        const manfaat = plant.manfaat || "";
        const detailUrl = `./?id=${encodeURIComponent(id)}`;

        const marker = document.createElement("a-marker");
        marker.setAttribute("type", "pattern");
        marker.setAttribute("url", `markers/${encodeURIComponent(id)}.patt`);
        marker.setAttribute("id", `m_${id}`);
        marker.setAttribute("smooth", "true");
        marker.setAttribute("smoothCount", "10");
        marker.setAttribute("smoothTolerance", "0.01");
        marker.setAttribute("smoothThreshold", "5");

        const panel = document.createElement("a-plane");
        panel.setAttribute("position", "0 0.6 0");
        panel.setAttribute("rotation", "-90 0 0");
        panel.setAttribute("width", "2.4");
        panel.setAttribute("height", "1.5");
        panel.setAttribute("material", "color:#000; opacity:0.45");
        marker.appendChild(panel);

        const assetId = ensureImageAsset(id, gambar);

        const img = document.createElement("a-image");
        img.setAttribute("position", "-0.95 0.8 0.01");
        img.setAttribute("rotation", "-90 0 0");
        img.setAttribute("width", "1.1");
        img.setAttribute("height", "1.1");
        img.setAttribute("src", `#${assetId}`);
        marker.appendChild(img);

        const txtName = document.createElement("a-text");
        txtName.setAttribute("position", "0 0.65 0.02");
        txtName.setAttribute("rotation", "-90 0 0");
        txtName.setAttribute("value", nama.toUpperCase());
        txtName.setAttribute("width", "2.3");
        txtName.setAttribute("align", "center");
        txtName.setAttribute("color", "#FFFFFF");
        txtName.setAttribute("outline-color", "#000000");
        txtName.setAttribute("outline-width", "4");
        marker.appendChild(txtName);

        const txtInfo = document.createElement("a-text");
        txtInfo.setAttribute("position", "0.45 0.78 0.02");
        txtInfo.setAttribute("rotation", "-90 0 0");
        txtInfo.setAttribute("value", manfaat ?? "Tidak ada informasi manfaat.");
        txtInfo.setAttribute("width", "2.3");
        txtInfo.setAttribute("align", "left");
        txtInfo.setAttribute("color", "#E8F5FF");
        txtInfo.setAttribute("outline-color", "#000000");
        txtInfo.setAttribute("outline-width", "3");
        marker.appendChild(txtInfo);

        marker.addEventListener("markerFound", () =>
          setMarkerFound(id, nama, detailUrl)
        );
        marker.addEventListener("markerLost", () => setMarkerLost(id));

        return marker;
      }

      function setupDebugMode(plants) {
        if (!DEBUG_MODE || !debugPanel || !debugSelect) return;

        debugPanel.style.display = "block";
        debugSelect.innerHTML = "";
        debugEvents.length = 0;
        debugLogEl.textContent = "[]";

        plants.forEach((p) => {
          const id = safeStr(p.id).trim();
          if (!id) return;
          const nama = safeStr(p.nama || id);
          const detailUrl = `./?id=${encodeURIComponent(id)}`;
          plantById.set(id, { id, nama, detailUrl });

          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `${nama} (${id})`;
          debugSelect.appendChild(opt);
        });

        // FIX: debugZSelect -> debugSelect
        debugFoundBtn.onclick = () => {
          const id = debugSelect.value;
          const plant = plantById.get(id);
          if (!plant) return;
          setMarkerFound(plant.id, plant.nama, plant.detailUrl);
        };

        debugLostBtn.onclick = () => {
          const id = debugSelect.value;
          if (!id) return;
          setMarkerLost(id);
        };

        debugResetBtn.onclick = () => {
          Array.from(lostTimers.keys()).forEach((id) => clearLostTimer(id));
          activeMarkers.clear();
          updateActiveUI();
          logDebug("reset");
        };

        debugExportBtn.onclick = async () => {
          const json = JSON.stringify(debugEvents, null, 2);
          try {
            await navigator.clipboard.writeText(json);
            alert("Log debug disalin ke clipboard.");
          } catch (_) {
            window.prompt("Copy JSON ini:", json);
          }
        };

        debugClearBtn.onclick = () => {
          debugEvents.length = 0;
          debugLogEl.textContent = "[]";
        };
      }

      async function loadPlants() {
        // Samakan dengan app.js: mode=list
        try {
          const dataset = await fetchJSON(`${API_URL}?mode=list`);
          const plants = Array.isArray(dataset)
            ? dataset
            : Object.values(dataset || {});
          if (plants.length > 0) return plants;
        } catch (error) {
          console.warn("Remote API gagal, fallback ke data lokal", error);
        }

        const local = await fetchJSON(LOCAL_DATA_URL);
        return Array.isArray(local) ? local : Object.values(local || {});
      }

      async function main() {
        hud.textContent = "AR TOGA • Memuat data tanaman...";
        try {
          const plants = await loadPlants();

          if (!plants.length) {
            hud.textContent = "AR TOGA • Data tanaman kosong";
            return;
          }

          plants.forEach((p) => {
            const marker = makeMarker(p);
            if (marker) root.appendChild(marker);
          });

          setupDebugMode(plants);
          hud.textContent = "AR TOGA • Siap. Arahkan kamera ke marker pattern.";
        } catch (e) {
          console.error(e);
          hud.textContent =
            "AR TOGA • Gagal memuat data (cek koneksi/API/data lokal).";
        }
      }

      main();
    </script>
  </body>
</html>
